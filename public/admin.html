<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</title>
  
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script defer crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script defer crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script defer src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <style>
    body{margin:0;padding:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Roboto',sans-serif;background:#f5f5f5;}
    .category-scroll{overflow-x:auto;scrollbar-width:none;-ms-overflow-style:none;}
    .category-scroll::-webkit-scrollbar{display:none;}
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    const AdminPanel = () => {
      const [activeTab, setActiveTab] = useState('orders');
      const [products, setProducts] = useState([]);
      const [orders, setOrders] = useState([]);
      const [customers, setCustomers] = useState([]);
      const [loading, setLoading] = useState(true);
      const [editingProduct, setEditingProduct] = useState(null);
      const [showProductForm, setShowProductForm] = useState(false);
      const [supabase, setSupabase] = useState(null);
      const [orderFilter, setOrderFilter] = useState('all');
      const [selectedCategory, setSelectedCategory] = useState('all');
      const [categories, setCategories] = useState([]);
      const [toast, setToast] = useState(null);
      const [broadcastMessage, setBroadcastMessage] = useState('');
      const [broadcastMessageKk, setBroadcastMessageKk] = useState('');
      const [isSendingBroadcast, setIsSendingBroadcast] = useState(false);
      
      const [productForm, setProductForm] = useState({
        name: '', 
        name_kk: '', 
        description: '', 
        description_kk: '',
        price: '', 
        category: '', 
        category_kk: '',
        image_url: '',
        badge: '',
        available: true,
        stock: 999
      });
      
      const [settings, setSettings] = useState({
        kaspi_phone: '',
        kaspi_link: '',
        shop_phone: '',
        contact_phone: '',
        contact_address: '',
        payment_enabled: false
      });

      const tg = window.Telegram?.WebApp;

      useEffect(() => {
        if (tg) {
          tg.ready();
          tg.expand();
        }
        initSupabase();
      }, []);

      const initSupabase = async () => {
        try {
          const configResponse = await fetch('/api/config');
          const config = await configResponse.json();
          
          const { createClient } = window.supabase;
          const client = createClient(config.supabaseUrl, config.supabaseKey);
          
          setSupabase(client);
          await loadData(client);
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
          setLoading(false);
        }
      };

      const loadData = async (client) => {
        try {
          const { data: productsData } = await client
            .from('flowers_products')
            .select('*')
            .order('created_at', { ascending: false });
          
          setProducts(productsData || []);
          
          // –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
          const uniqueCategories = [...new Set(productsData?.map(p => p.category).filter(Boolean))];
          setCategories(uniqueCategories);

          const { data: ordersData } = await client
            .from('flowers_orders')
            .select('*')
            .order('created_at', { ascending: false });
          
          setOrders(ordersData || []);

          const { data: customersData } = await client
            .from('flowers_customers')
            .select('*');
          
          setCustomers(customersData || []);

          const { data: settingsData } = await client
            .from('flowers_settings')
            .select('*')
            .eq('id', 1)
            .single();
          
          if (settingsData) {
            setSettings(settingsData);
          }
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
        } finally {
          setLoading(false);
        }
      };

      const showToast = (message, type = 'success') => {
        setToast({ message, type });
        setTimeout(() => setToast(null), 3000);
      };

      const saveProduct = async () => {
        try {
          if (editingProduct) {
            await supabase
              .from('flowers_products')
              .update(productForm)
              .eq('id', editingProduct.id);
            showToast('–¢–æ–≤–∞—Ä –æ–±–Ω–æ–≤–ª—ë–Ω! ‚úÖ');
          } else {
            await supabase
              .from('flowers_products')
              .insert([productForm]);
            showToast('–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω! ‚úÖ');
          }
          
          setShowProductForm(false);
          setEditingProduct(null);
          setProductForm({
            name: '', name_kk: '', description: '', description_kk: '',
            price: '', category: '', category_kk: '', image_url: '', badge: '', available: true
          });
          loadData(supabase);
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
          showToast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
        }
      };

      const deleteProduct = async (id) => {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä?')) return;
        try {
          await supabase.from('flowers_products').delete().eq('id', id);
          showToast('–¢–æ–≤–∞—Ä —É–¥–∞–ª—ë–Ω! üóëÔ∏è');
          loadData(supabase);
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', error);
          showToast('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è', 'error');
        }
      };

      const updateOrderStatus = async (orderId, newStatus) => {
        try {
          const { data: order } = await supabase
            .from('flowers_orders')
            .update({ status: newStatus })
            .eq('id', orderId)
            .select()
            .single();

          await fetch('/api/notify-status', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              userId: order.telegram_user_id,
              status: newStatus,
              orderNumber: orderId, // –ü–æ–ª–Ω—ã–π –Ω–æ–º–µ—Ä
              orderId: orderId,
              shopPhone: settings.shop_phone
            })
          });

          showToast('–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª—ë–Ω! ‚úÖ');
          loadData(supabase);
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:', error);
          showToast('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è', 'error');
        }
      };

      const sendPhotoPrompt = async (orderId, telegramUserId, photoType) => {
        if (!telegramUserId) {
          showToast('–ù–µ—Ç Telegram ID –∫–ª–∏–µ–Ω—Ç–∞', 'error');
          return;
        }

        try {
          await fetch('/api/send-photo-prompt', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              orderId,
              telegramUserId,
              photoType  // 'bouquet' –∏–ª–∏ 'delivery'
            })
          });

          showToast('‚úÖ –ó–∞–ø—Ä–æ—Å –Ω–∞ —Ñ–æ—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ –±–æ—Ç!');
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞:', error);
          showToast('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏', 'error');
        }
      };

      const saveSettings = async () => {
        try {
          await supabase
            .from('flowers_settings')
            .update(settings)
            .eq('id', 1);

          showToast('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã! ‚öôÔ∏è');
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫:', error);
          showToast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
        }
      };

      const sendBroadcast = async () => {
        if (!broadcastMessage.trim() || !broadcastMessageKk.trim()) {
          showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ –æ–±–æ–∏—Ö —è–∑—ã–∫–∞—Ö', 'error');
          return;
        }

        if (!confirm(`–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É –≤—Å–µ–º –∫–ª–∏–µ–Ω—Ç–∞–º (${customers.length} —á–µ–ª.)?`)) {
          return;
        }

        setIsSendingBroadcast(true);

        try {
          const response = await fetch('/api/send-broadcast', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              messageRu: broadcastMessage,
              messageKk: broadcastMessageKk,
              customers: customers
            })
          });

          if (response.ok) {
            showToast(`‚úÖ –†–∞—Å—Å—ã–ª–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞! (${customers.length} –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π)`);
            setBroadcastMessage('');
            setBroadcastMessageKk('');
          } else {
            showToast('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ä–∞—Å—Å—ã–ª–∫–∏', 'error');
          }
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏:', error);
          showToast('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏', 'error');
        } finally {
          setIsSendingBroadcast(false);
        }
      };

      const filteredOrders = orderFilter === 'all' 
        ? orders 
        : orders.filter(order => order.status === orderFilter);
      
      const filteredProducts = selectedCategory === 'all' 
        ? products 
        : products.filter(p => p.category === selectedCategory);

      const stats = {
        totalOrders: orders.length,
        pending: orders.filter(o => o.status === 'pending').length,
        processing: orders.filter(o => o.status === 'processing').length,
        delivered: orders.filter(o => o.status === 'delivered').length,
        totalRevenue: orders
          .filter(o => o.status === 'delivered')
          .reduce((sum, o) => sum + (o.total || 0), 0)
      };

      if (loading) {
        return (
          <div className="min-h-screen flex items-center justify-center bg-gray-100">
            <div className="text-center">
              <div className="text-6xl mb-4 animate-bounce">‚öôÔ∏è</div>
              <p className="text-gray-600 font-medium">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-gray-50 pb-20">
          {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ */}
          <div className="bg-black text-white p-6 shadow-lg">
            <h1 className="text-2xl font-bold mb-1">‚öôÔ∏è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h1>
            <p className="text-gray-300">–¶–≤–µ—Ç–æ—á–Ω–∞—è –õ–∞–≤–∫–∞</p>
          </div>

          {/* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */}
          <div className="p-4 grid grid-cols-2 gap-3 mb-4">
            <div className="bg-white rounded-xl p-4 border border-gray-200">
              <p className="text-gray-500 text-sm mb-1">–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</p>
              <p className="text-2xl font-bold text-gray-900">{stats.totalOrders}</p>
            </div>
            <div className="bg-white rounded-xl p-4 border border-gray-200">
              <p className="text-gray-500 text-sm mb-1">–î–æ—Ö–æ–¥</p>
              <p className="text-2xl font-bold text-gray-900">{stats.totalRevenue} ‚Ç∏</p>
            </div>
            <div className="bg-yellow-50 rounded-xl p-4 border border-yellow-200">
              <p className="text-yellow-700 text-sm mb-1">–û–∂–∏–¥–∞—é—Ç</p>
              <p className="text-2xl font-bold text-yellow-700">{stats.pending}</p>
            </div>
            <div className="bg-green-50 rounded-xl p-4 border border-green-200">
              <p className="text-green-700 text-sm mb-1">–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ</p>
              <p className="text-2xl font-bold text-green-700">{stats.delivered}</p>
            </div>
          </div>

          {/* –¢–∞–±—ã */}
          <div className="flex gap-2 px-4 mb-4 overflow-x-auto">
            {['–¢–æ–≤–∞—Ä—ã', '–ó–∞–∫–∞–∑—ã', '–ö–ª–∏–µ–Ω—Ç—ã', '–†–∞—Å—Å—ã–ª–∫–∞', '–ù–∞—Å—Ç—Ä–æ–π–∫–∏'].map((tab, idx) => {
              const tabValue = ['products', 'orders', 'customers', 'broadcast', 'settings'][idx];
              return (
                <button
                  key={tab}
                  onClick={() => setActiveTab(tabValue)}
                  className={`px-4 py-2 rounded-lg font-medium whitespace-nowrap transition-all ${
                    activeTab === tabValue
                      ? 'bg-black text-white'
                      : 'bg-white text-gray-700 border border-gray-300'
                  }`}
                >
                  {tab}
                </button>
              );
            })}
          </div>

          {/* –¢–æ–≤–∞—Ä—ã */}
          {activeTab === 'products' && (
            <div className="px-4">
              <button
                onClick={() => {
                  setShowProductForm(true);
                  setEditingProduct(null);
                  setProductForm({
                    name: '', name_kk: '', description: '', description_kk: '',
                    price: '', category: '', category_kk: '', image_url: '', badge: '', available: true
                  });
                }}
                className="w-full bg-black text-white py-3 rounded-xl font-bold mb-4"
              >
                + –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä
              </button>

              {/* –§–∏–ª—å—Ç—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º */}
              <div className="category-scroll flex gap-2 mb-4 pb-2">
                <button
                  onClick={() => setSelectedCategory('all')}
                  className={`px-4 py-2 rounded-full whitespace-nowrap text-sm font-medium transition-all ${
                    selectedCategory === 'all'
                      ? 'bg-black text-white'
                      : 'bg-white border border-gray-300 text-gray-700'
                  }`}
                >
                  –í—Å–µ
                </button>
                {categories.map(category => (
                  <button
                    key={category}
                    onClick={() => setSelectedCategory(category)}
                    className={`px-4 py-2 rounded-full whitespace-nowrap text-sm font-medium transition-all ${
                      selectedCategory === category
                        ? 'bg-black text-white'
                        : 'bg-white border border-gray-300 text-gray-700'
                    }`}
                  >
                    {category}
                  </button>
                ))}
              </div>

              {/* –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ */}
              <div className="space-y-3">
                {filteredProducts.map(product => (
                  <div key={product.id} className="bg-white rounded-xl p-4 border border-gray-200">
                    <div className="flex gap-3">
                      <div className="w-20 h-20 bg-gray-100 rounded-lg flex-shrink-0">
                        {product.image_url ? (
                          <img src={product.image_url} alt={product.name} className="w-full h-full object-cover rounded-lg"/>
                        ) : (
                          <div className="w-full h-full flex items-center justify-center text-3xl">üå∫</div>
                        )}
                      </div>
                      <div className="flex-1">
                        <div className="flex items-start justify-between mb-2">
                          <div>
                            <h3 className="font-bold text-gray-900">{product.name}</h3>
                            <p className="text-sm text-gray-500">{product.category}</p>
                          </div>
                          <div className="flex gap-2">
                            <button
                              onClick={() => {
                                setEditingProduct(product);
                                setProductForm(product);
                                setShowProductForm(true);
                              }}
                              className="text-blue-600 text-xl"
                            >
                              ‚úèÔ∏è
                            </button>
                            <button
                              onClick={() => deleteProduct(product.id)}
                              className="text-red-600 text-xl"
                            >
                              üóëÔ∏è
                            </button>
                          </div>
                        </div>
                        <div className="flex items-center justify-between">
                          <span className="font-bold text-gray-900">{product.price} ‚Ç∏</span>
                          <div className="flex items-center gap-2">
                            {product.stock !== undefined && (
                              <span className={`px-2 py-1 rounded-full text-xs font-medium ${
                                product.stock === 0 ? 'bg-red-100 text-red-700' :
                                product.stock < 5 ? 'bg-yellow-100 text-yellow-700' :
                                'bg-blue-100 text-blue-700'
                              }`}>
                                üì¶ {product.stock === 999 ? '‚àû' : product.stock} —à—Ç
                              </span>
                            )}
                            <span className={`px-2 py-1 rounded-full text-xs font-medium ${
                              product.available ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500'
                            }`}>
                              {product.available ? '‚úì –í –Ω–∞–ª–∏—á–∏–∏' : '‚úï –ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏'}
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* –ó–∞–∫–∞–∑—ã */}
          {activeTab === 'orders' && (
            <div className="px-4">
              <div className="flex gap-2 mb-4 overflow-x-auto pb-2">
                {[
                  { value: 'all', label: '–í—Å–µ', count: orders.length },
                  { value: 'pending', label: '–û–∂–∏–¥–∞—é—Ç', count: stats.pending },
                  { value: 'processing', label: '–í —Ä–∞–±–æ—Ç–µ', count: stats.processing },
                  { value: 'delivered', label: '–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ', count: stats.delivered },
                  { value: 'cancelled', label: '–û—Ç–º–µ–Ω—ë–Ω–Ω—ã–µ', count: orders.filter(o => o.status === 'cancelled').length }
                ].map(filter => (
                  <button
                    key={filter.value}
                    onClick={() => setOrderFilter(filter.value)}
                    className={`px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap ${
                      orderFilter === filter.value
                        ? 'bg-black text-white'
                        : 'bg-white border border-gray-300 text-gray-700'
                    }`}
                  >
                    {filter.label} ({filter.count})
                  </button>
                ))}
              </div>

              <div className="space-y-3">
                {filteredOrders.map(order => (
                  <div key={order.id} className="bg-white rounded-xl p-4 border border-gray-200">
                    <div className="flex justify-between items-start mb-3">
                      <div>
                        <p className="font-bold text-gray-900">–ó–∞–∫–∞–∑ #{order.id}</p>
                        <p className="text-sm text-gray-500">
                          {new Date(order.created_at).toLocaleString('ru-RU')}
                        </p>
                        <p className="text-sm text-gray-700 mt-1">
                          üë§ {order.customer_name} | üìû +7{order.customer_phone}
                        </p>
                      </div>
                      <span className={`px-3 py-1 rounded-full text-xs font-medium ${
                        order.status === 'delivered' ? 'bg-green-100 text-green-700' :
                        order.status === 'ready' ? 'bg-blue-100 text-blue-700' :
                        order.status === 'processing' ? 'bg-yellow-100 text-yellow-700' :
                        order.status === 'cancelled' ? 'bg-red-100 text-red-700' :
                        'bg-gray-100 text-gray-700'
                      }`}>
                        {order.status === 'pending' ? '–û–∂–∏–¥–∞–µ—Ç' :
                         order.status === 'processing' ? '–í —Ä–∞–±–æ—Ç–µ' :
                         order.status === 'ready' ? '–ì–æ—Ç–æ–≤' :
                         order.status === 'delivered' ? '–î–æ—Å—Ç–∞–≤–ª–µ–Ω' :
                         order.status === 'cancelled' ? '–û—Ç–º–µ–Ω—ë–Ω' :
                         order.status}
                      </span>
                    </div>

                    <div className="mb-3 text-sm text-gray-600">
                      {order.items?.map((item, idx) => (
                        <div key={idx}>‚Ä¢ {item.name} x{item.quantity} - {item.price * item.quantity} ‚Ç∏</div>
                      ))}
                    </div>

                    {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–æ—Å—Ç–∞–≤–∫–µ */}
                    {order.delivery_type === 'delivery' ? (
                      <div className="mb-3 text-sm bg-blue-50 p-3 rounded-lg border border-blue-200">
                        <p className="font-semibold text-blue-900 mb-1">üöö –î–æ—Å—Ç–∞–≤–∫–∞</p>
                        <p className="text-blue-800">üìç {order.delivery_address}</p>
                        <p className="text-blue-800">üìÖ {order.delivery_date} ‚è∞ {order.delivery_time}</p>
                      </div>
                    ) : (
                      <div className="mb-3 text-sm bg-gray-50 p-2 rounded">
                        üè™ –°–∞–º–æ–≤—ã–≤–æ–∑
                      </div>
                    )}

                    {order.comment && (
                      <div className="mb-3 text-sm text-gray-600 bg-gray-50 p-2 rounded">
                        üí¨ {order.comment}
                      </div>
                    )}

                    {/* –î–µ—Ç–∞–ª–∏ –æ–ø–ª–∞—Ç—ã */}
                    {order.cashback_used && order.cashback_used > 0 ? (
                      <div className="mb-3 bg-gradient-to-r from-green-50 to-emerald-50 p-3 rounded-lg border border-green-200">
                        <p className="font-semibold text-gray-900 mb-2">üí∞ –û–ø–ª–∞—Ç–∞ —Å –∫—ç—à–±–µ–∫–æ–º</p>
                        <div className="space-y-1 text-sm">
                          <div className="flex justify-between text-gray-700">
                            <span>–°—É–º–º–∞ —Ç–æ–≤–∞—Ä–æ–≤:</span>
                            <span className="font-medium">{order.subtotal} ‚Ç∏</span>
                          </div>
                          <div className="flex justify-between text-green-700">
                            <span>üí∞ –û–ø–ª–∞—á–µ–Ω–æ –∫—ç—à–±–µ–∫–æ–º:</span>
                            <span className="font-bold">-{order.cashback_used} ‚Ç∏</span>
                          </div>
                          <div className="flex justify-between text-gray-900 pt-1 border-t border-green-200">
                            <span className="font-semibold">–ö –æ–ø–ª–∞—Ç–µ –¥–µ–Ω—å–≥–∞–º–∏:</span>
                            <span className="font-bold text-lg">{order.total} ‚Ç∏</span>
                          </div>
                        </div>
                      </div>
                    ) : (
                      <div className="mb-3 bg-gray-50 p-3 rounded-lg border border-gray-200">
                        <div className="flex justify-between items-center text-sm">
                          <span className="text-gray-600">üíµ –ö –æ–ø–ª–∞—Ç–µ:</span>
                          <span className="font-bold text-gray-900 text-lg">{order.total} ‚Ç∏</span>
                        </div>
                      </div>
                    )}

                    {/* –°—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∑–∞–∫–∞–∑ –æ–∂–∏–¥–∞–µ—Ç */}
                    {order.status === 'pending' && (
                      <div className="mb-3 bg-yellow-50 p-3 rounded-lg border border-yellow-300">
                        <div className="flex items-center gap-2">
                          <span className="text-yellow-700 font-medium">‚è≥ –û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—É</span>
                        </div>
                        <p className="text-xs text-yellow-600 mt-1">
                          –ö–ª–∏–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —á–µ–∫. –ü–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —á–µ–∫–∞ —Å—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–∏—Ç—Å—è –Ω–∞ "–í —Ä–∞–±–æ—Ç–µ".
                        </p>
                      </div>
                    )}

                    {(order.status === 'processing' || order.status === 'ready' || order.status === 'delivered') && (
                      <div className="mb-3 bg-green-50 p-3 rounded-lg border border-green-300">
                        <div className="flex items-center gap-2">
                          <span className="text-green-700 font-medium">‚úÖ –û–ø–ª–∞—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞</span>
                        </div>
                      </div>
                    )}

                    {/* –ö–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ç–æ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –ø–æ–∑–≤–æ–ª—è–µ—Ç */}
                    {order.telegram_user_id && (order.status === 'processing' || order.status === 'ready' || order.status === 'delivered') && (
                      <div className="pt-3 border-t border-gray-200 space-y-2">
                        <div className="grid grid-cols-2 gap-2">
                          <button
                            onClick={() => sendPhotoPrompt(order.id, order.telegram_user_id, 'bouquet')}
                            className="px-3 py-2 bg-gradient-to-r from-pink-500 to-rose-500 text-white rounded-lg text-sm font-medium hover:from-pink-600 hover:to-rose-600 flex items-center justify-center gap-1"
                          >
                            üíê –§–æ—Ç–æ –±—É–∫–µ—Ç–∞
                          </button>
                          <button
                            onClick={() => sendPhotoPrompt(order.id, order.telegram_user_id, 'delivery')}
                            className="px-3 py-2 bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-lg text-sm font-medium hover:from-blue-600 hover:to-cyan-600 flex items-center justify-center gap-1"
                          >
                            üì¶ –§–æ—Ç–æ –¥–æ—Å—Ç–∞–≤–∫–∏
                          </button>
                        </div>
                      </div>
                    )}

                    <div className="flex justify-between items-center pt-3 border-t border-gray-200">
                      <span className="text-sm text-gray-500">–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞:</span>
                      <select
                        value={order.status}
                        onChange={(e) => updateOrderStatus(order.id, e.target.value)}
                        className="px-3 py-1 border border-gray-300 rounded-lg text-sm"
                      >
                        <option value="pending">–û–∂–∏–¥–∞–µ—Ç</option>
                        <option value="processing">–í —Ä–∞–±–æ—Ç–µ</option>
                        <option value="ready">–ì–æ—Ç–æ–≤</option>
                        <option value="delivered">–î–æ—Å—Ç–∞–≤–ª–µ–Ω</option>
                        <option value="cancelled">–û—Ç–º–µ–Ω—ë–Ω</option>
                      </select>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* –ö–ª–∏–µ–Ω—Ç—ã */}
          {activeTab === 'customers' && (
            <div className="px-4">
              <div className="space-y-3">
                {customers.map(customer => (
                  <div key={customer.id} className="bg-white rounded-xl p-4 border border-gray-200">
                    <div className="flex items-center gap-3 mb-2">
                      <div className="w-12 h-12 bg-black rounded-full flex items-center justify-center text-white font-bold text-xl">
                        {customer.first_name?.charAt(0) || '?'}
                      </div>
                      <div>
                        <p className="font-bold text-gray-900">{customer.first_name} {customer.last_name}</p>
                        <p className="text-sm text-gray-500">@{customer.telegram_username || '–Ω–µ—Ç username'}</p>
                      </div>
                    </div>
                    <div className="grid grid-cols-2 gap-2 text-sm">
                      <div className="bg-gray-50 p-2 rounded">
                        <p className="text-gray-500">–ó–∞–∫–∞–∑–æ–≤</p>
                        <p className="font-bold text-gray-900">{customer.total_orders || 0}</p>
                      </div>
                      <div className="bg-gray-50 p-2 rounded">
                        <p className="text-gray-500">–ö—ç—à–±–µ–∫</p>
                        <p className="font-bold text-gray-900">{customer.cashback_balance || 0} ‚Ç∏</p>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* –†–∞—Å—Å—ã–ª–∫–∞ */}
          {activeTab === 'broadcast' && (
            <div className="px-4">
              <div className="bg-white rounded-xl p-6 border border-gray-200">
                <div className="mb-6">
                  <div className="flex items-center gap-2 mb-4">
                    <span className="text-3xl">üì¢</span>
                    <div>
                      <h2 className="text-xl font-bold text-gray-900">–†–∞—Å—Å—ã–ª–∫–∞</h2>
                      <p className="text-sm text-gray-500">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤—Å–µ–º –∫–ª–∏–µ–Ω—Ç–∞–º ({customers.length} —á–µ–ª.)</p>
                    </div>
                  </div>

                  <div className="space-y-4">
                    {/* –°–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ —Ä—É—Å—Å–∫–æ–º */}
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        üá∑üá∫ –°–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ —Ä—É—Å—Å–∫–æ–º
                      </label>
                      <textarea
                        value={broadcastMessage}
                        onChange={(e) => setBroadcastMessage(e.target.value)}
                        placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ..."
                        className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:border-black focus:ring-2 focus:ring-black focus:ring-opacity-20 min-h-[120px]"
                        disabled={isSendingBroadcast}
                      />
                      <p className="text-xs text-gray-500 mt-1">
                        {broadcastMessage.length} —Å–∏–º–≤–æ–ª–æ–≤
                      </p>
                    </div>

                    {/* –°–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ –∫–∞–∑–∞—Ö—Å–∫–æ–º */}
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        üá∞üáø –°–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ –∫–∞–∑–∞—Ö—Å–∫–æ–º
                      </label>
                      <textarea
                        value={broadcastMessageKk}
                        onChange={(e) => setBroadcastMessageKk(e.target.value)}
                        placeholder="“ö–∞–∑–∞“õ —Ç—ñ–ª—ñ–Ω–¥–µ —Ö–∞–±–∞—Ä–ª–∞–º–∞ –º”ô—Ç—ñ–Ω—ñ–Ω –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑..."
                        className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:border-black focus:ring-2 focus:ring-black focus:ring-opacity-20 min-h-[120px]"
                        disabled={isSendingBroadcast}
                      />
                      <p className="text-xs text-gray-500 mt-1">
                        {broadcastMessageKk.length} —Å–∏–º–≤–æ–ª–æ–≤
                      </p>
                    </div>

                    {/* –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ */}
                    <button
                      onClick={sendBroadcast}
                      disabled={isSendingBroadcast || !broadcastMessage.trim() || !broadcastMessageKk.trim()}
                      className={`w-full py-3 rounded-xl font-bold text-lg transition-all ${
                        isSendingBroadcast || !broadcastMessage.trim() || !broadcastMessageKk.trim()
                          ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                          : 'bg-black text-white hover:bg-gray-800'
                      }`}
                    >
                      {isSendingBroadcast ? '‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞...' : `üì¢ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ–º (${customers.length})`}
                    </button>

                    {/* –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ */}
                    <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                      <p className="text-sm text-yellow-800">
                        ‚ö†Ô∏è <strong>–í–Ω–∏–º–∞–Ω–∏–µ:</strong> –°–æ–æ–±—â–µ–Ω–∏–µ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –í–°–ï–ú –∫–ª–∏–µ–Ω—Ç–∞–º. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ç–µ–∫—Å—Ç –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω –Ω–∞ –æ–±–æ–∏—Ö —è–∑—ã–∫–∞—Ö.
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ */}
          {activeTab === 'settings' && (
            <div className="px-4">
              <div className="bg-white rounded-xl p-4 border border-gray-200 space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">–¢–µ–ª–µ—Ñ–æ–Ω –º–∞–≥–∞–∑–∏–Ω–∞</label>
                  <input
                    type="text"
                    value={settings.shop_phone || ''}
                    onChange={(e) => setSettings({...settings, shop_phone: e.target.value})}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                    placeholder="+7 777 123 45 67"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Kaspi —Ç–µ–ª–µ—Ñ–æ–Ω</label>
                  <input
                    type="text"
                    value={settings.kaspi_phone || ''}
                    onChange={(e) => setSettings({...settings, kaspi_phone: e.target.value})}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                    placeholder="+7 777 123 45 67"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Kaspi —Å—Å—ã–ª–∫–∞</label>
                  <input
                    type="text"
                    value={settings.kaspi_link || ''}
                    onChange={(e) => setSettings({...settings, kaspi_link: e.target.value})}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                    placeholder="https://kaspi.kz/..."
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω</label>
                  <input
                    type="text"
                    value={settings.contact_phone || ''}
                    onChange={(e) => setSettings({...settings, contact_phone: e.target.value})}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">–ê–¥—Ä–µ—Å</label>
                  <input
                    type="text"
                    value={settings.contact_address || ''}
                    onChange={(e) => setSettings({...settings, contact_address: e.target.value})}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                    placeholder="—É–ª. –ê–±–∞—è, 10"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Instagram</label>
                  <input
                    type="text"
                    value={settings.instagram || ''}
                    onChange={(e) => setSettings({...settings, instagram: e.target.value})}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                    placeholder="@your_flower_shop"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã</label>
                  <input
                    type="text"
                    value={settings.working_hours || ''}
                    onChange={(e) => setSettings({...settings, working_hours: e.target.value})}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                    placeholder="–ü–Ω-–í—Å: 9:00 - 21:00"
                  />
                </div>

                <div className="flex items-center gap-3">
                  <input
                    type="checkbox"
                    id="paymentEnabled"
                    checked={settings.payment_enabled || false}
                    onChange={(e) => setSettings({...settings, payment_enabled: e.target.checked})}
                    className="w-5 h-5"
                  />
                  <label htmlFor="paymentEnabled" className="text-sm font-medium text-gray-700">
                    –í–∫–ª—é—á–∏—Ç—å –æ–Ω–ª–∞–π–Ω-–æ–ø–ª–∞—Ç—É
                  </label>
                </div>

                <button
                  onClick={saveSettings}
                  className="w-full bg-black text-white py-3 rounded-xl font-bold"
                >
                  –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                </button>
              </div>
            </div>
          )}

          {/* –§–æ—Ä–º–∞ —Ç–æ–≤–∞—Ä–∞ */}
          {showProductForm && (
            <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
              <div className="bg-white rounded-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto p-6">
                <h2 className="text-xl font-bold text-gray-900 mb-4">
                  {editingProduct ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä' : '–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä'}
                </h2>
                
                <div className="space-y-3">
                  <input
                    type="text"
                    placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (RU)"
                    value={productForm.name}
                    onChange={(e) => setProductForm({...productForm, name: e.target.value})}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                  />
                  <input
                    type="text"
                    placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (KK)"
                    value={productForm.name_kk}
                    onChange={(e) => setProductForm({...productForm, name_kk: e.target.value})}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                  />
                  <textarea
                    placeholder="–û–ø–∏—Å–∞–Ω–∏–µ (RU)"
                    value={productForm.description}
                    onChange={(e) => setProductForm({...productForm, description: e.target.value})}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                    rows="2"
                  />
                  <textarea
                    placeholder="–û–ø–∏—Å–∞–Ω–∏–µ (KK)"
                    value={productForm.description_kk}
                    onChange={(e) => setProductForm({...productForm, description_kk: e.target.value})}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                    rows="2"
                  />
                  <input
                    type="number"
                    placeholder="–¶–µ–Ω–∞"
                    value={productForm.price}
                    onChange={(e) => setProductForm({...productForm, price: e.target.value})}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                  />
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      üì¶ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (–æ—Å—Ç–∞—Ç–æ–∫)
                    </label>
                    <input
                      type="number"
                      placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ"
                      value={productForm.stock}
                      onChange={(e) => setProductForm({...productForm, stock: parseInt(e.target.value) || 0})}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                      min="0"
                    />
                    <p className="text-xs text-gray-500 mt-1">
                      üí° –ü—Ä–∏ 0 —Ç–æ–≤–∞—Ä —Å–∫—Ä–æ–µ—Ç—Å—è –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞. 999 = "–º–Ω–æ–≥–æ"
                    </p>
                  </div>
                  <input
                    type="text"
                    placeholder="–ö–∞—Ç–µ–≥–æ—Ä–∏—è (RU)"
                    value={productForm.category}
                    onChange={(e) => setProductForm({...productForm, category: e.target.value})}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                  />
                  <input
                    type="text"
                    placeholder="–ö–∞—Ç–µ–≥–æ—Ä–∏—è (KK)"
                    value={productForm.category_kk}
                    onChange={(e) => setProductForm({...productForm, category_kk: e.target.value})}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                  />
                  <input
                    type="text"
                    placeholder="URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è"
                    value={productForm.image_url}
                    onChange={(e) => setProductForm({...productForm, image_url: e.target.value})}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                  />
                  <select
                    value={productForm.badge}
                    onChange={(e) => setProductForm({...productForm, badge: e.target.value})}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                  >
                    <option value="">–ë–µ–∑ –±–µ–π–¥–∂–∞</option>
                    <option value="new">üéâ –ù–æ–≤–∏–Ω–∫–∞</option>
                    <option value="hit">‚≠ê –•–∏—Ç</option>
                  </select>
                  <div className="flex items-center gap-3">
                    <input
                      type="checkbox"
                      id="available"
                      checked={productForm.available}
                      onChange={(e) => setProductForm({...productForm, available: e.target.checked})}
                      className="w-5 h-5"
                    />
                    <label htmlFor="available" className="font-medium text-gray-700">
                      –í –Ω–∞–ª–∏—á–∏–∏
                    </label>
                  </div>
                </div>

                <div className="flex gap-3 mt-6">
                  <button
                    onClick={() => {
                      setShowProductForm(false);
                      setEditingProduct(null);
                    }}
                    className="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl font-bold"
                  >
                    –û—Ç–º–µ–Ω–∞
                  </button>
                  <button
                    onClick={saveProduct}
                    className="flex-1 bg-black text-white py-3 rounded-xl font-bold"
                  >
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Toast */}
          {toast && (
            <div className="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-50">
              <div className={`${
                toast.type === 'success' ? 'bg-black' : 'bg-red-500'
              } text-white px-6 py-4 rounded-2xl shadow-2xl`}>
                <div className="flex items-center gap-3">
                  <span className="text-2xl">{toast.type === 'success' ? '‚úì' : '‚úï'}</span>
                  <p className="font-medium">{toast.message}</p>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    ReactDOM.render(<AdminPanel />, document.getElementById('root'));
  </script>
</body>
</html>
