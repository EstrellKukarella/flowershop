<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–¶–≤–µ—Ç–æ—á–Ω–∞—è –õ–∞–≤–∫–∞ üå∏</title>
  
  <link rel="preconnect" href="https://unpkg.com">
  <link rel="preconnect" href="https://cdn.tailwindcss.com">
  
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script defer crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script defer crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script defer src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <style>
    body{margin:0;padding:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Roboto',sans-serif;background: linear-gradient(135deg, #fdfcfb 0%, #fff5f7 100%);}
    @keyframes slideDown{from{opacity:0;transform:translate(-50%,-20px)}to{opacity:1;transform:translate(-50%,0)}}
    .animate-slideDown{animation:slideDown 0.3s ease-out}
    .line-clamp-2{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    .animate-fadeIn{animation:fadeIn 0.3s ease-out}
    .animate-slideUp{animation:slideUp 0.5s ease-out}
    .onboarding-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:linear-gradient(135deg, #fdfcfb 0%, #fff5f7 100%);z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px}
    .flower-card{transition:all 0.3s ease;border:2px solid transparent;}
    .flower-card:hover{border-color:#ec4899;box-shadow:0 10px 30px rgba(236, 72, 153, 0.2);transform:translateY(-2px);}
    .gradient-pink{background:linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);}
    .gradient-rose{background:linear-gradient(135deg, #fff1f2 0%, #ffe4e6 100%);}
  </style>
</head>
<body>
  <div id="root"></div>
  
  <!-- Onboarding —ç–∫—Ä–∞–Ω -->
  <div id="onboarding" class="onboarding-overlay" style="display: none;">
    <div class="animate-slideUp text-center max-w-lg px-6">
      <!-- –õ–æ–≥–æ—Ç–∏–ø —Ü–≤–µ—Ç–∫–∞ -->
      <div class="mb-8">
        <div class="w-32 h-32 mx-auto rounded-full bg-gradient-to-br from-pink-400 to-rose-500 flex items-center justify-center shadow-2xl">
          <span class="text-7xl">üå∏</span>
        </div>
      </div>
      
      <!-- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ -->
      <h1 class="text-2xl font-semibold text-gray-600 mb-3" id="onboarding-welcome">
        –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!
      </h1>
      
      <!-- –ù–∞–∑–≤–∞–Ω–∏–µ -->
      <h2 class="text-4xl font-bold bg-gradient-to-r from-pink-500 to-rose-500 bg-clip-text text-transparent mb-6" id="onboarding-company">
        –¶–≤–µ—Ç–æ—á–Ω–∞—è –õ–∞–≤–∫–∞
      </h2>
      
      <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
      <p class="text-gray-600 mb-10 text-xl leading-relaxed" id="onboarding-subtitle">
        –°–≤–µ–∂–∏–µ —Ü–≤–µ—Ç—ã —Å –¥–æ—Å—Ç–∞–≤–∫–æ–π –ø—Ä—è–º–æ –∫ –≤–∞—à–µ–π –¥–≤–µ—Ä–∏
      </p>
      
      <!-- –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ -->
      <div class="space-y-5 mb-10 text-left">
        <div class="flex items-start gap-4 bg-white rounded-2xl p-4 shadow-sm">
          <div class="w-12 h-12 bg-pink-100 rounded-xl flex items-center justify-center flex-shrink-0">
            <span class="text-2xl">üåπ</span>
          </div>
          <div>
            <p class="text-gray-800 font-semibold text-lg" id="onboarding-feature1-title">–í—Å–µ–≥–¥–∞ —Å–≤–µ–∂–∏–µ</p>
            <p class="text-gray-500" id="onboarding-feature1-desc">–ë—É–∫–µ—Ç—ã –∏–∑ —Å–≤–µ–∂–∏—Ö —Ü–≤–µ—Ç–æ–≤ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å</p>
          </div>
        </div>
        
        <div class="flex items-start gap-4 bg-white rounded-2xl p-4 shadow-sm">
          <div class="w-12 h-12 bg-pink-100 rounded-xl flex items-center justify-center flex-shrink-0">
            <span class="text-2xl">üöö</span>
          </div>
          <div>
            <p class="text-gray-800 font-semibold text-lg" id="onboarding-feature2-title">–ë—ã—Å—Ç—Ä–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞</p>
            <p class="text-gray-500" id="onboarding-feature2-desc">–ü–æ –≤—Å–µ–π –ê—Å—Ç–∞–Ω–µ –∑–∞ 2 —á–∞—Å–∞</p>
          </div>
        </div>
        
        <div class="flex items-start gap-4 bg-white rounded-2xl p-4 shadow-sm">
          <div class="w-12 h-12 bg-pink-100 rounded-xl flex items-center justify-center flex-shrink-0">
            <span class="text-2xl">üíê</span>
          </div>
          <div>
            <p class="text-gray-800 font-semibold text-lg" id="onboarding-feature3-title">–ë–æ–ª—å—à–æ–π –≤—ã–±–æ—Ä</p>
            <p class="text-gray-500" id="onboarding-feature3-desc">–ë—É–∫–µ—Ç—ã –Ω–∞ –ª—é–±–æ–π –≤–∫—É—Å –∏ –ø–æ–≤–æ–¥</p>
          </div>
        </div>
      </div>
      
      <!-- –ö–Ω–æ–ø–∫–∞ -->
      <button 
        onclick="closeOnboarding()" 
        class="w-full bg-gradient-to-r from-pink-500 to-rose-500 hover:from-pink-600 hover:to-rose-600 text-white py-5 rounded-2xl font-bold text-xl shadow-xl transition-all transform hover:scale-105"
        id="onboarding-button"
      >
        –í—ã–±—Ä–∞—Ç—å –±—É–∫–µ—Ç üíê
      </button>
    </div>
  </div>
  
  <script>
    // –¢–µ–∫—Å—Ç—ã –¥–ª—è onboarding
    const onboardingTranslations = {
      ru: {
        welcome: '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!',
        company: '–¶–≤–µ—Ç–æ—á–Ω–∞—è –õ–∞–≤–∫–∞',
        subtitle: '–°–≤–µ–∂–∏–µ —Ü–≤–µ—Ç—ã —Å –¥–æ—Å—Ç–∞–≤–∫–æ–π –ø—Ä—è–º–æ –∫ –≤–∞—à–µ–π –¥–≤–µ—Ä–∏',
        feature1Title: '–í—Å–µ–≥–¥–∞ —Å–≤–µ–∂–∏–µ',
        feature1Desc: '–ë—É–∫–µ—Ç—ã –∏–∑ —Å–≤–µ–∂–∏—Ö —Ü–≤–µ—Ç–æ–≤ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å',
        feature2Title: '–ë—ã—Å—Ç—Ä–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞',
        feature2Desc: '–ü–æ –≤—Å–µ–π –ê—Å—Ç–∞–Ω–µ –∑–∞ 2 —á–∞—Å–∞',
        feature3Title: '–ë–æ–ª—å—à–æ–π –≤—ã–±–æ—Ä',
        feature3Desc: '–ë—É–∫–µ—Ç—ã –Ω–∞ –ª—é–±–æ–π –≤–∫—É—Å –∏ –ø–æ–≤–æ–¥',
        button: '–í—ã–±—Ä–∞—Ç—å –±—É–∫–µ—Ç üíê'
      },
      kk: {
        welcome: '“ö–æ—à –∫–µ–ª–¥—ñ“£—ñ–∑!',
        company: '–ì“Ø–ª –î“Ø–∫–µ–Ω—ñ',
        subtitle: '–ï—Å—ñ–≥—ñ“£—ñ–∑–≥–µ –∂–µ—Ç–∫—ñ–∑—ñ–ª–µ—Ç—ñ–Ω –∂–∞“£–∞ –≥“Ø–ª–¥–µ—Ä',
        feature1Title: '”ò—Ä“õ–∞—à–∞–Ω –∂–∞“£–∞',
        feature1Desc: '–ö“Ø–Ω —Å–∞–π—ã–Ω –∂–∞“£–∞ –≥“Ø–ª–¥–µ—Ä–¥–µ–Ω —à–æ“õ—Ç–∞—Ä',
        feature2Title: '–ñ—ã–ª–¥–∞–º –∂–µ—Ç–∫—ñ–∑—É',
        feature2Desc: '–ê—Å—Ç–∞–Ω–∞ –±–æ–π—ã–Ω—à–∞ 2 —Å–∞“ì–∞—Ç—Ç–∞',
        feature3Title: '“Æ–ª–∫–µ–Ω —Ç–∞“£–¥–∞—É',
        feature3Desc: '–ö–µ–∑ –∫–µ–ª–≥–µ–Ω —Ç–∞–ª“ì–∞–º –º–µ–Ω —Å–µ–±–µ–ø–∫–µ —à–æ“õ—Ç–∞—Ä',
        button: '–®–æ“õ —Ç–∞“£–¥–∞—É üíê'
      }
    };
    
    function detectOnboardingLanguage() {
      if (window.Telegram?.WebApp?.initDataUnsafe?.user?.language_code === 'kk') {
        return 'kk';
      }
      return 'ru';
    }
    
    function setOnboardingLanguage() {
      const lang = detectOnboardingLanguage();
      const t = onboardingTranslations[lang];
      
      document.getElementById('onboarding-welcome').textContent = t.welcome;
      document.getElementById('onboarding-company').textContent = t.company;
      document.getElementById('onboarding-subtitle').textContent = t.subtitle;
      document.getElementById('onboarding-feature1-title').textContent = t.feature1Title;
      document.getElementById('onboarding-feature1-desc').textContent = t.feature1Desc;
      document.getElementById('onboarding-feature2-title').textContent = t.feature2Title;
      document.getElementById('onboarding-feature2-desc').textContent = t.feature2Desc;
      document.getElementById('onboarding-feature3-title').textContent = t.feature3Title;
      document.getElementById('onboarding-feature3-desc').textContent = t.feature3Desc;
      document.getElementById('onboarding-button').textContent = t.button;
    }
    
    function checkOnboarding() {
      const hasSeenOnboarding = localStorage.getItem('hasSeenFlowerOnboarding');
      if (!hasSeenOnboarding) {
        setOnboardingLanguage();
        document.getElementById('onboarding').style.display = 'flex';
      }
    }
    
    function closeOnboarding() {
      localStorage.setItem('hasSeenFlowerOnboarding', 'true');
      document.getElementById('onboarding').style.display = 'none';
    }
    
    window.addEventListener('DOMContentLoaded', checkOnboarding);
  </script>

  <script type="text/babel">
    const { useState, useEffect } = React;
    
    const FlowerShop = () => {
      const [lang, setLang] = useState('ru');
      const [view, setView] = useState('catalog');
      const [products, setProducts] = useState([]);
      const [cart, setCart] = useState([]);
      const [customer, setCustomer] = useState(null);
      const [orders, setOrders] = useState([]);
      const [settings, setSettings] = useState(null);
      const [toast, setToast] = useState(null);
      const [loading, setLoading] = useState(true);
      const [supabase, setSupabase] = useState(null);
      const [cashbackTransactions, setCashbackTransactions] = useState([]);
      const [useCashback, setUseCashback] = useState(false);
      const [cashbackAmount, setCashbackAmount] = useState(0);
      
      const tg = window.Telegram?.WebApp;
      
      // –ü–µ—Ä–µ–≤–æ–¥—ã
      const translations = {
        ru: {
          catalog: '–ö–∞—Ç–∞–ª–æ–≥',
          cart: '–ö–æ—Ä–∑–∏–Ω–∞',
          orders: '–ó–∞–∫–∞–∑—ã',
          profile: '–ü—Ä–æ—Ñ–∏–ª—å',
          cashback: '–ö—ç—à–±–µ–∫',
          toCart: '–í –∫–æ—Ä–∑–∏–Ω—É',
          inCart: '–í –∫–æ—Ä–∑–∏–Ω–µ',
          empty: '–ü—É—Å—Ç–æ',
          total: '–ò—Ç–æ–≥–æ',
          order: '–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑',
          name: '–í–∞—à–µ –∏–º—è',
          phone: '–¢–µ–ª–µ—Ñ–æ–Ω',
          comment: '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–∫–∞–∑—É',
          orderSuccess: '–ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω!',
          thankYou: '–°–ø–∞—Å–∏–±–æ –∑–∞ –∑–∞–∫–∞–∑! –ú—ã —Å–∫–æ—Ä–æ —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏.',
          noProducts: '–¢–æ–≤–∞—Ä—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è...',
          noOrders: '–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤',
          status: {
            pending: '‚è∞ –û–∂–∏–¥–∞–µ—Ç',
            processing: 'üë®‚Äçüç≥ –ì–æ—Ç–æ–≤–∏—Ç—Å—è',
            ready: '‚úÖ –ì–æ—Ç–æ–≤',
            delivered: 'üéâ –î–æ—Å—Ç–∞–≤–ª–µ–Ω',
            cancelled: '‚ùå –û—Ç–º–µ–Ω—ë–Ω'
          },
          fresh: '–°–≤–µ–∂–∏–µ —Ü–≤–µ—Ç—ã',
          bestseller: '–•–∏—Ç –ø—Ä–æ–¥–∞–∂',
          new: '–ù–æ–≤–∏–Ω–∫–∞'
        },
        kk: {
          catalog: '–ö–∞—Ç–∞–ª–æ–≥',
          cart: '–°–µ–±–µ—Ç',
          orders: '–¢–∞–ø—Å—ã—Ä—ã—Å—Ç–∞—Ä',
          profile: '–ü—Ä–æ—Ñ–∏–ª—å',
          cashback: '–ö—ç—à–±–µ–∫',
          toCart: '–°–µ–±–µ—Ç–∫–µ',
          inCart: '–°–µ–±–µ—Ç—Ç–µ',
          empty: '–ë–æ—Å',
          total: '–ë–∞—Ä–ª—ã“ì—ã',
          order: '–¢–∞–ø—Å—ã—Ä—ã—Å –±–µ—Ä—É',
          name: '–ê—Ç—ã“£—ã–∑',
          phone: '–¢–µ–ª–µ—Ñ–æ–Ω',
          comment: '–¢–∞–ø—Å—ã—Ä—ã—Å“õ–∞ —Ç“Ø—Å—ñ–Ω—ñ–∫—Ç–µ–º–µ',
          orderSuccess: '–¢–∞–ø—Å—ã—Ä—ã—Å —Ä”ô—Å—ñ–º–¥–µ–ª–¥—ñ!',
          thankYou: '–¢–∞–ø—Å—ã—Ä—ã—Å—ã“£—ã–∑“ì–∞ —Ä–∞—Ö–º–µ—Ç! –ñ–∞“õ—ã–Ω–¥–∞ —Å—ñ–∑–±–µ–Ω —Ö–∞–±–∞—Ä–ª–∞—Å–∞–º—ã–∑.',
          noProducts: '–¢–∞—É–∞—Ä–ª–∞—Ä –∂“Ø–∫—Ç–µ–ª—É–¥–µ...',
          noOrders: '”ò–∑—ñ—Ä–≥–µ —Ç–∞–ø—Å—ã—Ä—ã—Å—Ç–∞—Ä—ã“£—ã–∑ –∂–æ“õ',
          status: {
            pending: '‚è∞ –ö“Ø—Ç—É–¥–µ',
            processing: 'üë®‚Äçüç≥ –î–∞–π—ã–Ω–¥–∞–ª—É–¥–∞',
            ready: '‚úÖ –î–∞–π—ã–Ω',
            delivered: 'üéâ –ñ–µ—Ç–∫—ñ–∑—ñ–ª–¥—ñ',
            cancelled: '‚ùå –ë–∞—Å —Ç–∞—Ä—Ç—ã–ª–¥—ã'
          },
          fresh: '–ñ–∞“£–∞ –≥“Ø–ª–¥–µ—Ä',
          bestseller: '–¢–∞–Ω—ã–º–∞–ª',
          new: '–ñ–∞“£–∞–ª—ã“õ'
        }
      };
      
      const t = translations[lang];
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
      useEffect(() => {
        tg?.ready();
        tg?.expand();
        tg?.enableClosingConfirmation();
        
        const userLang = tg?.initDataUnsafe?.user?.language_code;
        if (userLang === 'kk') setLang('kk');
        
        initSupabase();
      }, []);
      
      const initSupabase = async () => {
        try {
          const response = await fetch('/api/config');
          const config = await response.json();
          
          const supabaseClient = window.supabase.createClient(
            config.supabaseUrl,
            config.supabaseKey
          );
          
          setSupabase(supabaseClient);
          await loadData(supabaseClient);
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
          showToast('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', 'error');
        }
      };
      
      const loadData = async (client) => {
        try {
          // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤
          const { data: productsData } = await client
            .from('flowers_products')
            .select('*')
            .eq('available', true)
            .order('name');
          
          setProducts(productsData || []);
          
          // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫
          const { data: settingsData } = await client
            .from('flowers_settings')
            .select('*')
            .single();
          
          setSettings(settingsData);
          
          // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞
          const userId = tg?.initDataUnsafe?.user?.id;
          if (userId) {
            const { data: customerData } = await client
              .from('flowers_customers')
              .select('*')
              .eq('telegram_user_id', userId)
              .single();
            
            if (customerData) {
              setCustomer(customerData);
              
              // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤
              const { data: ordersData } = await client
                .from('flowers_orders')
                .select('*')
                .eq('telegram_user_id', userId)
                .order('created_at', { ascending: false });
              
              setOrders(ordersData || []);
              
              // –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –∫—ç—à–±–µ–∫–∞
              const { data: transactionsData } = await client
                .from('flowers_cashback_transactions')
                .select('*')
                .eq('telegram_user_id', userId)
                .order('created_at', { ascending: false });
              
              setCashbackTransactions(transactionsData || []);
            }
          }
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
        } finally {
          setLoading(false);
        }
      };
      
      const showToast = (message, type = 'success') => {
        setToast({ message, type });
        setTimeout(() => setToast(null), 3000);
      };
      
      const addToCart = (product) => {
        const existingItem = cart.find(item => item.id === product.id);
        if (existingItem) {
          setCart(cart.map(item => 
            item.id === product.id 
              ? { ...item, quantity: item.quantity + 1 }
              : item
          ));
        } else {
          setCart([...cart, { ...product, quantity: 1 }]);
        }
        tg?.HapticFeedback?.impactOccurred('light');
        showToast(lang === 'kk' ? '–°–µ–±–µ—Ç–∫–µ “õ–æ—Å—ã–ª–¥—ã! üõí' : '–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ—Ä–∑–∏–Ω—É! üõí');
      };
      
      const updateQuantity = (productId, delta) => {
        setCart(cart.map(item => {
          if (item.id === productId) {
            const newQuantity = item.quantity + delta;
            return newQuantity > 0 ? { ...item, quantity: newQuantity } : item;
          }
          return item;
        }).filter(item => item.quantity > 0));
      };
      
      const removeFromCart = (productId) => {
        setCart(cart.filter(item => item.id !== productId));
        tg?.HapticFeedback?.impactOccurred('medium');
      };
      
      const getTotalPrice = () => {
        const cartTotal = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
        if (useCashback && customer && customer.cashback_balance > 0) {
          const discount = Math.min(cashbackAmount, customer.cashback_balance, cartTotal);
          return Math.max(0, cartTotal - discount);
        }
        return cartTotal;
      };
      
      const getCartSubtotal = () => {
        return cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
      };
      
      const submitOrder = async () => {
        if (cart.length === 0) {
          showToast(lang === 'kk' ? '–°–µ–±–µ—Ç –±–æ—Å' : '–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞', 'error');
          return;
        }
        
        const name = document.getElementById('customerName')?.value?.trim();
        const phone = document.getElementById('customerPhone')?.value?.trim();
        const comment = document.getElementById('customerComment')?.value?.trim();
        
        if (!name || !phone) {
          showToast(lang === 'kk' ? '–¢–æ–ª—Ç—ã—Ä—ã“£—ã–∑ –±–∞—Ä–ª—ã“õ ”©—Ä—ñ—Å—Ç–µ—Ä–¥—ñ' : '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
          return;
        }
        
        try {
          const orderId = `order_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
          const userId = tg?.initDataUnsafe?.user?.id;
          const username = tg?.initDataUnsafe?.user?.username;
          
          const subtotal = getCartSubtotal();
          const cashbackUsed = useCashback ? Math.min(cashbackAmount, customer.cashback_balance, subtotal) : 0;
          const finalTotal = subtotal - cashbackUsed;
          
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î
          await supabase.from('flowers_orders').insert({
            id: orderId,
            telegram_user_id: userId,
            customer_name: name,
            customer_phone: phone,
            comment: comment,
            items: cart,
            subtotal: subtotal,
            cashback_used: cashbackUsed,
            total: finalTotal,
            status: 'pending'
          });
          
          // –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –∫—ç—à–±–µ–∫ - —Å–ø–∏—Å—ã–≤–∞–µ–º –∏ —Å–æ–∑–¥–∞—ë–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
          if (cashbackUsed > 0) {
            const newBalance = customer.cashback_balance - cashbackUsed;
            
            await supabase
              .from('flowers_customers')
              .update({ cashback_balance: newBalance })
              .eq('telegram_user_id', userId);
            
            await supabase
              .from('flowers_cashback_transactions')
              .insert({
                telegram_user_id: userId,
                order_id: orderId,
                type: 'spent',
                amount: cashbackUsed,
                balance_after: newBalance
              });
          }
          
          // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
          await fetch('/api/send-order', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              orderId,
              date: new Date().toISOString(),
              customerName: name,
              customerPhone: phone,
              customerComment: comment,
              telegramUserId: userId,
              telegramUsername: username,
              items: cart,
              subtotal: subtotal,
              cashbackUsed: cashbackUsed,
              total: finalTotal,
              paymentEnabled: settings?.payment_enabled || false,
              kaspiPhone: settings?.kaspi_phone,
              kaspiLink: settings?.kaspi_link
            })
          });
          
          setCart([]);
          setUseCashback(false);
          setCashbackAmount(0);
          setView('orders');
          showToast(t.orderSuccess);
          loadData(supabase);
          
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–∫–∞–∑–∞:', error);
          showToast(lang === 'kk' ? '“ö–∞—Ç–µ –æ—Ä—ã–Ω –∞–ª–¥—ã' : '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞', 'error');
        }
      };
      
      if (loading) {
        return (
          <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-pink-50 to-rose-50">
            <div className="text-center">
              <div className="text-6xl mb-4 animate-bounce">üå∏</div>
              <p className="text-gray-600 font-medium">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>
          </div>
        );
      }
      
      return (
        <div className="min-h-screen bg-gradient-to-br from-pink-50 via-white to-rose-50 pb-20">
          {/* –ö–∞—Ç–∞–ª–æ–≥ */}
          {view === 'catalog' && (
            <div className="p-4">
              {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ */}
              <div className="mb-6 text-center">
                <h1 className="text-3xl font-bold bg-gradient-to-r from-pink-500 to-rose-500 bg-clip-text text-transparent mb-2">
                  üå∏ {lang === 'kk' ? '–ì“Ø–ª –î“Ø–∫–µ–Ω—ñ' : '–¶–≤–µ—Ç–æ—á–Ω–∞—è –õ–∞–≤–∫–∞'}
                </h1>
                <p className="text-gray-600">{t.fresh}</p>
              </div>
              
              {/* –¢–æ–≤–∞—Ä—ã */}
              <div className="grid grid-cols-2 gap-3">
                {products.map(product => (
                  <div key={product.id} className="flower-card bg-white rounded-2xl shadow-sm overflow-hidden">
                    {/* –§–æ—Ç–æ */}
                    <div className="relative h-40 bg-gradient-to-br from-pink-100 to-rose-100">
                      {product.image_url ? (
                        <img 
                          src={product.image_url} 
                          alt={product.name}
                          className="w-full h-full object-cover"
                        />
                      ) : (
                        <div className="w-full h-full flex items-center justify-center text-5xl">
                          üå∫
                        </div>
                      )}
                      {product.badge && (
                        <div className="absolute top-2 right-2 bg-pink-500 text-white text-xs px-2 py-1 rounded-full font-bold">
                          {product.badge === 'new' ? (lang === 'kk' ? 'üéâ –ñ–∞“£–∞' : 'üéâ –ù–æ–≤–∏–Ω–∫–∞') :
                           product.badge === 'hit' ? (lang === 'kk' ? '‚≠ê –¢–∞–Ω—ã–º–∞–ª' : '‚≠ê –•–∏—Ç') :
                           product.badge}
                        </div>
                      )}
                    </div>
                    
                    {/* –ò–Ω—Ñ–æ */}
                    <div className="p-3">
                      <h3 className="font-semibold text-gray-800 text-sm mb-1 line-clamp-2">
                        {lang === 'kk' ? (product.name_kk || product.name) : product.name}
                      </h3>
                      <p className="text-xs text-gray-500 mb-2 line-clamp-1">
                        {lang === 'kk' ? (product.description_kk || product.description) : product.description}
                      </p>
                      <div className="flex items-center justify-between">
                        <span className="text-lg font-bold text-pink-600">
                          {product.price} ‚Ç∏
                        </span>
                        <button
                          onClick={() => addToCart(product)}
                          className="bg-gradient-to-r from-pink-500 to-rose-500 text-white px-4 py-1.5 rounded-lg text-sm font-medium shadow-sm hover:shadow-md transition-all"
                        >
                          {cart.find(item => item.id === product.id) ? t.inCart : t.toCart}
                        </button>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
              
              {products.length === 0 && (
                <div className="text-center py-20">
                  <div className="text-6xl mb-4">üå∑</div>
                  <p className="text-gray-500">{t.noProducts}</p>
                </div>
              )}
            </div>
          )}
          
          {/* –ö–æ—Ä–∑–∏–Ω–∞ */}
          {view === 'cart' && (
            <div className="p-4">
              <h2 className="text-2xl font-bold text-gray-800 mb-4">üõí {t.cart}</h2>
              
              {cart.length === 0 ? (
                <div className="text-center py-20">
                  <div className="text-6xl mb-4">üå∏</div>
                  <p className="text-gray-500 mb-4">{t.empty}</p>
                  <button
                    onClick={() => setView('catalog')}
                    className="bg-gradient-to-r from-pink-500 to-rose-500 text-white px-6 py-3 rounded-xl font-medium"
                  >
                    {lang === 'kk' ? '–ö–∞—Ç–∞–ª–æ–≥“õ–∞ –æ—Ä–∞–ª—É' : '–ö –∫–∞—Ç–∞–ª–æ–≥—É'}
                  </button>
                </div>
              ) : (
                <div className="space-y-3 mb-20">
                  {cart.map(item => (
                    <div key={item.id} className="bg-white rounded-xl p-4 shadow-sm">
                      <div className="flex gap-3">
                        <div className="w-20 h-20 bg-gradient-to-br from-pink-100 to-rose-100 rounded-lg flex items-center justify-center flex-shrink-0">
                          {item.image_url ? (
                            <img src={item.image_url} alt={item.name} className="w-full h-full object-cover rounded-lg"/>
                          ) : (
                            <span className="text-3xl">üå∫</span>
                          )}
                        </div>
                        <div className="flex-1">
                          <h3 className="font-semibold text-gray-800 text-sm">
                            {lang === 'kk' ? (item.name_kk || item.name) : item.name}
                          </h3>
                          <p className="text-pink-600 font-bold">{item.price} ‚Ç∏</p>
                          <div className="flex items-center gap-3 mt-2">
                            <button
                              onClick={() => updateQuantity(item.id, -1)}
                              className="w-8 h-8 bg-gray-100 rounded-lg flex items-center justify-center font-bold text-gray-600"
                            >
                              -
                            </button>
                            <span className="font-semibold">{item.quantity}</span>
                            <button
                              onClick={() => updateQuantity(item.id, 1)}
                              className="w-8 h-8 bg-gradient-to-r from-pink-500 to-rose-500 text-white rounded-lg flex items-center justify-center font-bold"
                            >
                              +
                            </button>
                            <button
                              onClick={() => removeFromCart(item.id)}
                              className="ml-auto text-red-500 text-sm"
                            >
                              üóëÔ∏è
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  ))}
                  
                  {/* –§–æ—Ä–º–∞ –∑–∞–∫–∞–∑–∞ */}
                  <div className="bg-white rounded-xl p-4 shadow-sm space-y-3">
                    <input
                      id="customerName"
                      type="text"
                      placeholder={t.name}
                      className="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-pink-500"
                    />
                    <input
                      id="customerPhone"
                      type="tel"
                      placeholder={t.phone}
                      className="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-pink-500"
                    />
                    <textarea
                      id="customerComment"
                      placeholder={t.comment}
                      rows="3"
                      className="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-pink-500"
                    />
                  </div>
                  
                  {/* –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫—ç—à–±–µ–∫–∞ */}
                  {customer && customer.cashback_balance > 0 && (
                    <div className="bg-green-50 border-2 border-green-200 rounded-xl p-4 shadow-sm">
                      <div className="flex items-center justify-between mb-3">
                        <div className="flex items-center gap-2">
                          <input
                            type="checkbox"
                            id="useCashback"
                            checked={useCashback}
                            onChange={(e) => {
                              setUseCashback(e.target.checked);
                              if (e.target.checked) {
                                setCashbackAmount(Math.min(customer.cashback_balance, getCartSubtotal()));
                              } else {
                                setCashbackAmount(0);
                              }
                            }}
                            className="w-5 h-5"
                          />
                          <label htmlFor="useCashback" className="font-semibold text-green-800">
                            {lang === 'kk' ? '–ö—ç—à–±–µ–∫—Ç—ñ –ø–∞–π–¥–∞–ª–∞–Ω—É' : '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫—ç—à–±–µ–∫'}
                          </label>
                        </div>
                        <span className="font-bold text-green-700">
                          {customer.cashback_balance} ‚Ç∏
                        </span>
                      </div>
                      
                      {useCashback && (
                        <div>
                          <label className="block text-sm text-gray-700 mb-2">
                            {lang === 'kk' ? '“ö–∞–Ω—à–∞ –ø–∞–π–¥–∞–ª–∞–Ω—É?' : '–°–∫–æ–ª—å–∫–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å?'}
                          </label>
                          <input
                            type="range"
                            min="0"
                            max={Math.min(customer.cashback_balance, getCartSubtotal())}
                            value={cashbackAmount}
                            onChange={(e) => setCashbackAmount(parseInt(e.target.value))}
                            className="w-full"
                          />
                          <div className="flex justify-between text-sm text-gray-600 mt-1">
                            <span>0 ‚Ç∏</span>
                            <span className="font-bold text-green-700">{cashbackAmount} ‚Ç∏</span>
                            <span>{Math.min(customer.cashback_balance, getCartSubtotal())} ‚Ç∏</span>
                          </div>
                        </div>
                      )}
                    </div>
                  )}
                  
                  {/* –ò—Ç–æ–≥–æ */}
                  <div className="bg-gradient-to-r from-pink-500 to-rose-500 rounded-xl p-4 text-white shadow-lg">
                    {useCashback && cashbackAmount > 0 && (
                      <div className="mb-3 pb-3 border-b border-pink-300">
                        <div className="flex justify-between text-sm mb-1">
                          <span>{lang === 'kk' ? '–ê—Ä–∞–ª—ã“õ —Å–æ–º–∞:' : '–ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π –∏—Ç–æ–≥:'}</span>
                          <span>{getCartSubtotal()} ‚Ç∏</span>
                        </div>
                        <div className="flex justify-between text-sm">
                          <span>{lang === 'kk' ? '–ö—ç—à–±–µ–∫ –∂–µ“£—ñ–ª–¥—ñ–≥—ñ:' : '–°–∫–∏–¥–∫–∞ –∫—ç—à–±–µ–∫:'}</span>
                          <span className="text-green-300">-{cashbackAmount} ‚Ç∏</span>
                        </div>
                      </div>
                    )}
                    <div className="flex justify-between items-center mb-3">
                      <span className="text-lg">{t.total}:</span>
                      <span className="text-2xl font-bold">{getTotalPrice()} ‚Ç∏</span>
                    </div>
                    <button
                      onClick={submitOrder}
                      className="w-full bg-white text-pink-600 py-3 rounded-xl font-bold text-lg shadow-md hover:shadow-xl transition-all"
                    >
                      {t.order} üíê
                    </button>
                  </div>
                </div>
              )}
            </div>
          )}
          
          {/* –ó–∞–∫–∞–∑—ã */}
          {view === 'orders' && (
            <div className="p-4">
              <h2 className="text-2xl font-bold text-gray-800 mb-4">üìã {t.orders}</h2>
              
              {orders.length === 0 ? (
                <div className="text-center py-20">
                  <div className="text-6xl mb-4">üå∑</div>
                  <p className="text-gray-500">{t.noOrders}</p>
                </div>
              ) : (
                <div className="space-y-3">
                  {orders.map(order => (
                    <div key={order.id} className="bg-white rounded-xl p-4 shadow-sm">
                      <div className="flex justify-between items-start mb-3">
                        <div>
                          <p className="font-semibold text-gray-800">
                            {lang === 'kk' ? '–¢–∞–ø—Å—ã—Ä—ã—Å' : '–ó–∞–∫–∞–∑'} #{order.id.slice(-6)}
                          </p>
                          <p className="text-sm text-gray-500">
                            {new Date(order.created_at).toLocaleDateString('ru-RU')}
                          </p>
                        </div>
                        <span className={`px-3 py-1 rounded-full text-sm font-medium ${
                          order.status === 'delivered' ? 'bg-green-100 text-green-700' :
                          order.status === 'ready' ? 'bg-blue-100 text-blue-700' :
                          order.status === 'processing' ? 'bg-yellow-100 text-yellow-700' :
                          order.status === 'cancelled' ? 'bg-red-100 text-red-700' :
                          'bg-gray-100 text-gray-700'
                        }`}>
                          {t.status[order.status]}
                        </span>
                      </div>
                      <div className="border-t border-gray-100 pt-3">
                        {order.items?.map((item, idx) => (
                          <p key={idx} className="text-sm text-gray-600">
                            ‚Ä¢ {item.name} x{item.quantity}
                          </p>
                        ))}
                        <p className="font-bold text-pink-600 mt-2">
                          {order.total} ‚Ç∏
                        </p>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          )}
          
          {/* –ö—ç—à–±–µ–∫ */}
          {view === 'cashback' && (
            <div className="p-4">
              <h2 className="text-2xl font-bold text-gray-800 mb-4">üí∞ {t.cashback}</h2>
              
              <div className="bg-gradient-to-br from-green-400 to-emerald-500 rounded-2xl p-6 text-white text-center mb-4 shadow-lg">
                <p className="text-lg mb-2">{lang === 'kk' ? '–°—ñ–∑–¥—ñ“£ –±–∞–ª–∞–Ω—Å—ã“£—ã–∑' : '–í–∞—à –±–∞–ª–∞–Ω—Å'}</p>
                <p className="text-5xl font-bold">{customer?.cashback_balance || 0} ‚Ç∏</p>
              </div>
              
              <div className="bg-white rounded-xl p-4 shadow-sm mb-4">
                <h3 className="font-semibold text-gray-800 mb-2">
                  {lang === 'kk' ? '–ö—ç—à–±–µ–∫ “õ–∞–ª–∞–π –∂“±–º—ã—Å —ñ—Å—Ç–µ–π–¥—ñ?' : '–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫—ç—à–±–µ–∫?'}
                </h3>
                <ul className="space-y-2 text-sm text-gray-600">
                  <li>‚Ä¢ {lang === 'kk' ? '”ò—Ä –∂–µ—Ç–∫—ñ–∑—ñ–ª–≥–µ–Ω —Ç–∞–ø—Å—ã—Ä—ã—Å—Ç–∞–Ω 5% –∫—ç—à–±–µ–∫' : '–ü–æ–ª—É—á–∞–π—Ç–µ 5% —Å –∫–∞–∂–¥–æ–≥–æ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞'}</li>
                  <li>‚Ä¢ {lang === 'kk' ? '–ö–µ–ª–µ—Å—ñ —Ç–∞–ø—Å—ã—Ä—ã—Å—Ç–∞ –ø–∞–π–¥–∞–ª–∞–Ω—É' : '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–∫–∞–∑–µ'}</li>
                  <li>‚Ä¢ {lang === 'kk' ? '–ñ–∏–Ω–∞“õ—Ç–∞–ª–∞–¥—ã –∞–≤—Ç–æ–º–∞—Ç—Ç—ã —Ç“Ø—Ä–¥–µ' : '–ù–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏'}</li>
                </ul>
              </div>
              
              {/* –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π */}
              {cashbackTransactions.length > 0 && (
                <div className="bg-white rounded-xl p-4 shadow-sm">
                  <h3 className="font-semibold text-gray-800 mb-3">
                    {lang === 'kk' ? '–¢–∞—Ä–∏—Ö' : '–ò—Å—Ç–æ—Ä–∏—è'}
                  </h3>
                  <div className="space-y-2">
                    {cashbackTransactions.map(transaction => (
                      <div key={transaction.id} className="flex items-center justify-between py-2 border-b border-gray-100 last:border-0">
                        <div className="flex items-center gap-3">
                          <div className={`w-10 h-10 rounded-full flex items-center justify-center ${
                            transaction.type === 'earned' ? 'bg-green-100' : 'bg-red-100'
                          }`}>
                            <span className="text-xl">
                              {transaction.type === 'earned' ? 'üí∞' : 'üõí'}
                            </span>
                          </div>
                          <div>
                            <p className="text-sm font-medium text-gray-800">
                              {transaction.type === 'earned' 
                                ? (lang === 'kk' ? '–ö—ç—à–±–µ–∫ –∂–∏–Ω–∞“õ—Ç–∞–ª–¥—ã' : '–ö—ç—à–±–µ–∫ –Ω–∞—á–∏—Å–ª–µ–Ω')
                                : (lang === 'kk' ? '–ö—ç—à–±–µ–∫ –ø–∞–π–¥–∞–ª–∞–Ω—ã–ª–¥—ã' : '–ö—ç—à–±–µ–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω')}
                            </p>
                            <p className="text-xs text-gray-500">
                              {new Date(transaction.created_at).toLocaleDateString('ru-RU')}
                            </p>
                          </div>
                        </div>
                        <div className="text-right">
                          <p className={`font-bold ${
                            transaction.type === 'earned' ? 'text-green-600' : 'text-red-600'
                          }`}>
                            {transaction.type === 'earned' ? '+' : '-'}{transaction.amount} ‚Ç∏
                          </p>
                          <p className="text-xs text-gray-400">
                            {lang === 'kk' ? '–ë–∞–ª–∞–Ω—Å:' : '–ë–∞–ª–∞–Ω—Å:'} {transaction.balance_after} ‚Ç∏
                          </p>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>
          )}
          
          {/* Toast */}
          {toast && (
            <div className="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-50 animate-slideDown max-w-sm w-full px-4">
              <div className={`${
                toast.type === 'success' ? 'bg-pink-600' : 'bg-red-500'
              } text-white px-6 py-4 rounded-2xl shadow-2xl`}>
                <div className="flex items-center gap-3">
                  <span className="text-2xl">{toast.type === 'success' ? '‚úÖ' : '‚ùå'}</span>
                  <div className="font-medium">{toast.message}</div>
                </div>
              </div>
            </div>
          )}
          
          {/* –ù–∞–≤–∏–≥–∞—Ü–∏—è */}
          <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-2xl z-50">
            <div className="flex justify-around items-center h-16 max-w-lg mx-auto">
              <button
                onClick={() => setView('catalog')}
                className={`flex flex-col items-center justify-center flex-1 h-full transition-colors ${
                  view === 'catalog' ? 'text-pink-600' : 'text-gray-400'
                }`}
              >
                <span className="text-2xl">üè†</span>
                <span className="text-xs mt-1 font-medium">{t.catalog}</span>
              </button>
              
              <button
                onClick={() => setView('cart')}
                className={`flex flex-col items-center justify-center flex-1 h-full transition-colors relative ${
                  view === 'cart' ? 'text-pink-600' : 'text-gray-400'
                }`}
              >
                <span className="text-2xl">üõí</span>
                {cart.length > 0 && (
                  <span className="absolute top-1 right-1/4 bg-red-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center font-bold">
                    {cart.length}
                  </span>
                )}
                <span className="text-xs mt-1 font-medium">{t.cart}</span>
              </button>
              
              <button
                onClick={() => setView('orders')}
                className={`flex flex-col items-center justify-center flex-1 h-full transition-colors ${
                  view === 'orders' ? 'text-pink-600' : 'text-gray-400'
                }`}
              >
                <span className="text-2xl">üìã</span>
                <span className="text-xs mt-1 font-medium">{t.orders}</span>
              </button>
              
              <button
                onClick={() => setView('cashback')}
                className={`flex flex-col items-center justify-center flex-1 h-full transition-colors ${
                  view === 'cashback' ? 'text-green-600' : 'text-gray-400'
                }`}
              >
                <span className="text-2xl">üí∞</span>
                <span className="text-xs mt-1 font-medium">{t.cashback}</span>
              </button>
            </div>
          </div>
        </div>
      );
    };

    ReactDOM.render(<FlowerShop />, document.getElementById('root'));
  </script>
</body>
</html>
